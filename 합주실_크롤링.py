# -*- coding: utf-8 -*-
"""í•©ì£¼ì‹¤ í¬ë¡¤ë§.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1W_0B5MTvUDQfNvzMduR5awaPPm8PJrY3
"""

!pip install selenium
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from bs4 import BeautifulSoup
from datetime import datetime

import time
import json
import os
import re
import tempfile


# í¬ë¡¬ ë“œë¼ì´ë²„ ì‹¤í–‰
temp_dir = tempfile.mkdtemp()

options = Options()
options.add_argument('--headless')
options.add_argument('--no-sandbox')
options.add_argument('--disable-dev-shm-usage')
options.add_argument(f'--user-data-dir={temp_dir}')

driver = webdriver.Chrome(options=options)

target_year = "2025"
target_month = "05"
target_date = "13"
target_times = ["19"]

target_str = f"{target_year}-{target_month}-{target_date}"

# ë“œë¦¼ í•©ì£¼ì‹¤

# ì˜ˆì•½ í˜ì´ì§€ë¡œ ì´ë™
driver.get("https://www.xn--hy1bm6g6ujjkgomr.com/bbs/board.php?bo_table=booking&cp_code=&mode=orderform&rm_ix=25")

# 2ì´ˆ ì •ë„ ëŒ€ê¸° (ìº˜ë¦°ë” ë¡œë”© ì‹œê°„)
time.sleep(1)

# ë‚ ì§œ í´ë¦­ (ì˜ˆ: 2025-04-10)
xpath_expr = f'//div[contains(@id, "{target_str}_day")]'
target_element = WebDriverWait(driver, 10).until(
    EC.presence_of_element_located((By.XPATH, xpath_expr))
)
target_element.click()

# ì •ë³´ê°€ ê°±ì‹ ë˜ë„ë¡ ì ê¹ ê¸°ë‹¤ë¦¼
time.sleep(1)  # ë˜ëŠ” WebDriverWaitë¡œ ë°”ê¿”ë„ ì¢‹ì•„

# time-list (ul íƒœê·¸)ê°€ ëœ° ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
WebDriverWait(driver, 10).until(
    EC.presence_of_element_located((By.ID, "time-list"))
)

# ul#time-list ì•ˆì˜ ëª¨ë“  label.btn-time ìš”ì†Œë“¤ ì°¾ê¸°
time_labels = driver.find_elements(By.CSS_SELECTOR, "#time-list label.btn-time")

# ê° labelì˜ title ì†ì„± ì¶”ì¶œ
available_times = [label.get_attribute("title") for label in time_labels]

available = []

for t in available_times:  # ìœ„ ë‘ ë¬¸ìì—´ì´ ë‹´ê¸´ ë¦¬ìŠ¤íŠ¸
    if "ìµœëŒ€" in t:
        available.append(int(t.split("ì‹œ")[0]))

print(target_times[0] in available)

# ê·¸ë£¨ë¸Œ í•©ì£¼ì‹¤

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âœ… 2. ë¡œê·¸ì¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
driver.get("https://www.groove4.co.kr/member/login.asp")

USER_ID = "summit2025"
USER_PW = "sumsum12!@"

WebDriverWait(driver, 10).until(
    EC.presence_of_element_located((By.NAME, "login_id"))
).send_keys(USER_ID)

driver.find_element(By.NAME, "login_pw").send_keys(USER_PW)

WebDriverWait(driver, 10).until(
    EC.element_to_be_clickable((By.XPATH, '//input[@alt="ë¡œê·¸ì¸"]'))
).click()

time.sleep(1)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âœ… 3. ì˜ˆì•½ í˜ì´ì§€ ì´ë™
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
driver.get("https://www.groove4.co.kr/reservation/reservation.asp?shop=30&gubun=sadang")
time.sleep(1)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âœ… 4. í¬ë¡¤ë§
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
date_links = driver.find_elements(By.XPATH, "//a[contains(@onclick, 'setReserveDate')]")

all_reserved_data = []


# ê¸°ì¤€ ë‚ ì§œ (ë§¨ ì• ë‚ ì§œ)
start_str = date_links[0].get_attribute("onclick").split("'")[1]  # '2025-04-01'
start_date = datetime.strptime(start_str, "%Y-%m-%d")

# ëª©í‘œ ë‚ ì§œ
target_date_obj = datetime.strptime(target_str, "%Y-%m-%d")

# ë‚ ì§œ ì°¨ì´ ê³„ì‚°
delta_days = (target_date_obj - start_date).days

# ì¸ë±ìŠ¤ í™•ì¸
if 0 <= delta_days < len(date_links):
    tag = date_links[delta_days]
else:
    print("í•´ë‹¹ ë‚ ì§œê°€ ë¦¬ìŠ¤íŠ¸ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤.")

try:
    tag.click()
except Exception as e:
    print(f"âŒ ë‚ ì§œ í´ë¦­ ì‹¤íŒ¨: {target_str} ({e})")

print(f"ğŸ“… {target_str} ë¡œë”© ì¤‘...")
time.sleep(1)  # ë‚ ì§œ ë°”ë€ŒëŠ” ì‹œê°„ ëŒ€ê¸°

# íŒŒì‹±
soup = BeautifulSoup(driver.page_source, "html.parser")
reserve_elements = soup.select(".reserve_time_off")

for el in reserve_elements:
    el_id = el.get("id", "")
    match = re.match(rf"reserve_time_(1[3-6])_{target_times[0]}", el_id)
    if match:
        room = int(match.group(1))
        all_reserved_data.append({
            "ë‚ ì§œ": target_str,
            "ë°©ë²ˆí˜¸": room
        })

print(all_reserved_data)